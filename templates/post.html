{% extends "base.html" %}

{% block content %}
<body class="bg-secondary text-center">
    <div class="text-white pt-1">
        <!-- header image -->
        <div class="row justify-content-center mx-1">
            <a href="/"><img src="/static/indexlogo.png" class="img-fluid m-1" alt="..."></a>
        </div>

        <!-- board title -->
        <div class="row justify-content-center">
            <h1><a href="/{{ boardname }}/">/{{ boardname }}/</a></h1>
        </div>

        {% with messages = get_flashed_messages() %}{% if messages %}
            {% for message in messages %}
                <p class="text-danger">{{ message }}</p>
            {% endfor %}
        {% endif %}{% endwith %}

        <!-- content -->
        <main role="main" class="row inner thread cover m-2 text-left" id="thread">
            <!-- op -->
            <div class="row">
                <div id="op" class="col text-wrap">
                    <img src="{{ post.thumb }}" class="float-left mr-3 postmedia" data-media="{{ post.media }}" data-thumb="{{ post.thumb }}">
                    <div class="content float-left">
                        <h3>
                            {{ post.subject }} <small class="text-info">No. <a id="op" class="replyID">{{ post.id }}</a></small>
                        </h3>
                        <div class="text-wrap bodyText">{{ post.body }}</div>
                    </div>
                </div>
            </div>
            {% for reply in replies %}
                <div class="row reply m-1 ml-3 w-100">
                    <div id="re" class="col-auto text-wrap border border-dark p-2 pr-5">
                        {% if reply.thumb %}
                        <img src="{{ reply.thumb }}" class="float-left mr-3 postmedia" data-media="{{ reply.media }}" data-thumb="{{ reply.thumb }}">
                        {% endif %}
                        <div class="content float-left">
                            <h3>
                                <small class="text-info">No. <a id="{{ reply.id }}" class="replyID">{{ reply.id }}</a></small>
                            </h3>
                            <div class="text-wrap bodyText">{{ reply.body }}</div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </main>

        <form action="/{{ boardname }}/{{ post.id }}/" method="POST" enctype="multipart/form-data" class="bg-dark col-sm-3" id="replyBox" hidden>
            <div class="modal-body">
                <div class="form-check">
                {{ form.rules() }} 
                I have read the <a href="/rules.html">rules</a>
                </div>
                <div class="form-check">
                {{ form.body(class_='form-control', id="replyText", placeholder="Body", cols="35", rows="4") }}
                </div>
                <div class="form-check text-left">
                {{ form.media(class_='file', placeholder="media", accept="image/*,.webm,.mp4") }}
                </div>
                {{ form.hidden_tag() }}
            </div> 
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="javascript:closeReply(this.parentElement.parentElement);">Close</button>
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </form>

        <script>
            $(document).on("click", ".post", function () {
                var parent = $(this).data("id")
                if (parent != "op") {
                    $(".modal-body #replyBody").val(">>>" + parent + "\r\n");
                } else {
                    $(".modal-body #replyBody").val("");
                }
            })

            $(".postmedia").click(function() {
                console.log("here")
                if ($(this).data("media").indexOf(".webm") != -1 || $(this).data("media").indexOf(".mp4") != -1) { // image
                    if ($(this).prop("tagName") == "IMG") {
                        var thumb = $(this).data("thumb")
                        var media = $(this).data("media")
                        $(this).replaceWith(`<video controls autoplay loop class="float-left mr-3 postmedia"><source src='${media}'></video>`)
                    } else {
                        var thumb = $(this).data("thumb")
                        var media = $(this).data("media")
                        $(this).replaceWith(`<img src="${thumb}" class="float-left mr-3 postmedia" data-media="${media}" data-thumb="${thumb}">`)
                    }
                } else {
                    if ($(this).data("media") == $(this).attr("src")) {
                        $(this).attr("src", $(this).data("thumb"));
                    } else {
                        $(this).attr("src", $(this).data("media"));
                    }
                }
            })

            $(".replyID").click(function() {
                $("#replyBox").removeAttr("hidden");
                if ($(this).attr('id') != "op") {
                    $("#replyText").append(">>" + $(this).attr('id') + "&#13;&#10;");
                }
            });

            function closeReply(element) {
                $(element).attr("hidden", "hidden");
                //$("#replyText").val(""); for some reason, when i have this and they open a new text box, text wont be appended
            }

            $(document).ready(function() {
                $.each($(".bodyText"), function(index, element) {
                    // do greentexts
                    text = $(element).text().split("\n");
                    for(i = 0; i < text.length; i++) {
                        if (text[i].length > 2) {
                            if (text[i].indexOf("&gt;") == 0 && text[i].substring(4,8) != "&gt;") {
                                text[i] = "<div class='text-success'>" + text[i] + "</div>";
                            }
                        }
                    }
                    var newtext = text.join("<br/>")
                    $(element).html(newtext);

                    // hyperlinks
                    var urlRegex = /(https?:\/\/[^\s]+)/g;
                    text = $(element).text();
                    $(element).html(text.replace(urlRegex, function(url) {
                        return '<a target="_blank" href="' + url + '">' + url + '</a>';
                    }));
                });
            });
        </script>

{% endblock %}